name: CI for aipc-devkit

on:
  push: # Add specific branches or tags if needed, e.g., branches: [main]
  workflow_dispatch:
    inputs:
      upload_to_artifactory:
        description: 'Upload to Artifactory'
        required: true
        default: 'true'
      run_all_scans:
        description: 'Run scans (Bandit, ClamAV, Trivy, Coverity)'
        required: true
        default: 'true'
      run_linting:
        description: 'Run Linting (Linting, BlackFormatting)'
        required: true
        default: 'true'
      run_bandit_scan:
        description: 'Run Bandit Scan'
        required: true
        default: 'false'
      run_clamav_scan:
        description: 'Run ClamAV Scan'
        required: true
        default: 'false'
      run_trivy_scan:
        description: 'Run Trivy Scan'
        required: true
        default: 'false'
      run_coverity_scan:
        description: 'Run Coverity Scan'
        required: true
        default: 'false'

permissions: read-all # Adding Permission as Read for all of the available permissions

env:
  PythonVersion: "3.10.11"
  TrivyVersion: "0.58.0"
  CoverityProject: "intel/aipc-devkit-install"

jobs:
  BuildStage:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python and Package
        uses: ./.github/actions/envsetup

      - name: Build aipc-devkit and upload to Artifactory
        uses: ./.github/actions/buildartifact
        with:
          upload_to_artifactory: ${{ github.event.inputs.upload_to_artifactory }}
  
  BanditScan:
    name: BanditScan
    runs-on: ubuntu-24.04
    needs: [BuildStage]
    if: ${{ github.event.inputs.run_all_scans == 'true' || github.event.inputs.run_bandit_scan == 'true' }}
    steps:
      - name: CheckoutCode
        uses: actions/checkout@v4
      - name: RunBanditScan
        id: BanditScan
        uses: ./.github/actions/scans/bandit
        with:
          report_name: "bandit-results"
          upload_to_artifactory: ${{ github.event.inputs.upload_to_artifactory }}

  ClamAVScan:
    name: ClamAVScan
    runs-on: ubuntu-24.04
    needs: [BuildStage]
    if: ${{ github.event.inputs.run_all_scans == 'true' || github.event.inputs.run_clamav_scan == 'true' }}
    steps:
      - name: CheckoutCode
        uses: actions/checkout@v4
      - name: RunSourceClamAVScan
        id: ClamAVScanSource
        uses: ./.github/actions/scans/clamav
        with:
          report_name: "clamavsource-results"
          exclude_paths: ".git,.github"
          upload_to_artifactory: ${{ github.event.inputs.upload_to_artifactory }}
      - name: RunBinaryClamAVScan
        if: ${{ github.event.inputs.upload_to_artifactory == 'true' }}
        id: ClamAVScanBinary
        uses: ./.github/actions/scans/clamav
        with:
          report_name: "clamavbinary-results"
          exclude_paths: ".git"
          artifact_name: "ArtifactAIPC"
          artifact_path: "./ArtifactAIPC"
          upload_to_artifactory: ${{ github.event.inputs.upload_to_artifactory }}

  TrivyScan:
    name: TrivyScan
    runs-on: ubuntu-24.04
    needs: [BuildStage]
    if: ${{ github.event.inputs.run_all_scans == 'true' || github.event.inputs.run_trivy_scan == 'true' }}
    steps:
      - name: CheckoutCode
        uses: actions/checkout@v4
      - name: RunTrivyScan
        id: TrivyScan
        uses: ./.github/actions/scans/trivy
        with:
          trivy_version: ${{ env.TrivyVersion }}
          scan-type: 'fs'
          scan-ref: 'Prerequisites/PythonModules/requirements.txt' 
          severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
          scanners: 'vuln,secret,misconfig,license'
          report_name: "trivy-results"
          upload_to_artifactory: ${{ github.event.inputs.upload_to_artifactory }}

  CoverityScan:
    name: CoverityScan
    runs-on: ubuntu-24.04
    needs: [BuildStage]
    if: ${{ github.event.inputs.run_all_scans == 'true' || github.event.inputs.run_coverity_scan == 'true' }}
    steps:
      - name: CheckoutCode
        uses: actions/checkout@v4
      - name: RunCoverityScan
        id: RunCoverityScan
        uses: ./.github/actions/scans/coverity
        with:
          project: ${{ env.CoverityProject }}
          build_language: 'other' # Python
          command: '--no-command --fs-capture-search ${{ github.workspace }}'
          email: ${{ secrets.COVERITY_SCAN_EMAIL }}
          token: ${{ secrets.COVERITY_SCAN_TOKEN }}
          report_name: "coverity-results"
          upload_to_artifactory: ${{ github.event.inputs.upload_to_artifactory }}
  
  # CodeCoverage:
  #   name: CodeCoverage
  #   runs-on: ubuntu-24.04
  #   needs: [BanditScan, ClamAVScan, TrivyScan, CoverityScan]
  #   steps:
  #     - name: CheckoutCode
  #       uses: actions/checkout@v4
  #     - name: RunCodeCoverage
  #       id: CodeCoverage
  #       uses: ./.github/actions/coverage
  #       with:
  #         project_directory: "."
  #         upload_to_artifactory: ${{ github.event.inputs.upload_to_artifactory }}

  Linting:
    name: Linting
    runs-on: ubuntu-24.04
    needs: [BuildStage]
    if: ${{ github.event.inputs.run_linting == 'true' }}
    steps:
      - name: CheckoutCode
        uses: actions/checkout@v4
      - name: RunLinting
        id: Linting
        uses: ./.github/actions/linting
        with:
          upload_to_artifactory: ${{ github.event.inputs.upload_to_artifactory }}

  BlackFormatting:
    name: BlackFormatting
    runs-on: windows-latest
    needs: [BuildStage]
    if: ${{ github.event.inputs.run_linting == 'true' }}
    steps:
      - name: CheckoutCode
        uses: actions/checkout@v4
      - name: RunBlackFormatting
        id: BlackFormatting
        uses: ./.github/actions/blackformatting
        with:
          python-version: ${{ env.PythonVersion }}
          upload_to_artifactory: ${{ github.event.inputs.upload_to_artifactory }}